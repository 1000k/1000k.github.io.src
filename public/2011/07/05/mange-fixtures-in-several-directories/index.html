<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title> fixtureをディレクトリに分けて管理する &middot; 1000g </title>


<link rel="stylesheet" href="http://1000k.github.io//css/slim.css">
<link rel="stylesheet" href="http://1000k.github.io//css/highlight.min.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600&subset=latin,latin-ext' rel='stylesheet'>

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="1000g" />

</head>

<body>
  <div class="container">
    <div class="header">
  <h1 class="site-title"><a href="http://1000k.github.io/">1000g</a></h1>
  <p class="site-tagline">Tech blog</p>
  <div class="nav">
    <a class="nav-btn" href="#">
      <span class="ci ci-burger"></span>
    </a>
    <ul class="nav-list">
       
	  <li class="spacer">&ac;</li>

      <li><a href="https://github.com/1000k">Github</a></li> 
      <li><a href="https://twitter.com/1000kei">Twitter</a></li> 
    </ul>
  </div>
</div>
    <div class="content">
      <div class="post">
        <h2 class="post-title"><a href="http://1000k.github.io/2011/07/05/mange-fixtures-in-several-directories/">fixtureをディレクトリに分けて管理する</a></h2>
        <div class="post-content">
          

<p><strong>(2011/07/15 Update) 7/13以前のコードに誤りがあり、正しく動作しなかったので修正しました。</strong></p>

<h2 id="やりたいこと:06041edaaf4ad9c158653456ce78f617">やりたいこと</h2>

<p>CakePHPの規則に従うと、フィクスチャは /app/test/fixtures/ ディレクトリにすべて入れなければなりません。この場合、「同じモデルを使うけど、テストケース毎に異なるフィクスチャを代入したい」という要望をかなえるのが難しいです。</p>

<p>例えば、</p>

<ul>
<li>Hige コントローラー</li>
<li>Moja コントローラー</li>
</ul>

<p>どちらも同じ Uso モデルを使う場合を考えます。</p>

<p>それぞれで違うフィクスチャを使いたくても、Uso モデルのフィクスチャは uso_fixture.php の1個です。フィクスチャの値を両方のテストケースで使えるようにするのは難しく、まして複数人でテスト設計するのは困難です。</p>

<p>そこで、それぞれのコントローラーから呼び出すフィクスチャを</p>

<ul>
<li>/app/test/fixtures/hige/uso_fixture.php</li>
<li>/app/test/fixtures/moja/uso_fixture.php</li>
</ul>

<p>と使い分けられるようにする方法を考えました。</p>

<h2 id="やり方:06041edaaf4ad9c158653456ce78f617">やり方</h2>

<p>CakeTestCase を拡張した MyCakeTestCase を作成し、その中で _loadFixtures をオーバーライドします。</p>

<p>なお、参考にしたバージョンは CakePHP 1.3.10 です。</p>

<p><strong>/app/libs/my_cake_test_case.php</strong></p>

<pre><code>&lt;?php
/**
 * Extension of CakeTestCase Class
 *
 * @author  $Author: senge.keiyo $
 * @version $id$
 */
class MyCakeTestCase extends CakeTestCase {

    /**
     * Load fixtures specified in var $fixtures.
     *
     * fixtureディレクトリ配下の任意のディレクトリにフィクスチャを配置できるよう拡張。
     *
     * 例えば $fixtures に 'app.unit_test.uso' と指定すると、
     * /app/tests/fixtures/unit_test/uso_fixture.php をロードできる。
     *
     * @author senda.keijiro
     * @return void
     * @access protected
     */
    function _loadFixtures() {
        if (!isset($this-&gt;fixtures) || empty($this-&gt;fixtures)) {
            return;
        }

        if (!is_array($this-&gt;fixtures)) {
            $this-&gt;fixtures = array_map('trim', explode(',', $this-&gt;fixtures));
        }

        $this-&gt;_fixtures = array();

        foreach ($this-&gt;fixtures as $index =&gt; $fixture) {
            $fixtureFile = null;
            $fixturePaths = null;

            if (strpos($fixture, 'core.') === 0) {
                $fixture = substr($fixture, strlen('core.'));
                foreach (App::core('cake') as $key =&gt; $path) {
                    $fixturePaths[] = $path . 'tests' . DS . 'fixtures';
                }
            } elseif (strpos($fixture, 'app.') === 0) {
                // MODIFIED
                // app.unittest.plan が来たら /fixtures/unittest/plan_fixtures.php
                // をロードするようにする
                $parts = explode('.', $fixture);
                $fixture = $parts[count($parts) - 1];

                array_shift($parts);
                array_pop($parts);
                $path = implode(DS, $parts);

                $fixturePaths = array(
                    TESTS . 'fixtures' . DS . $path,
                    TESTS . 'fixtures',
                    VENDORS . 'tests' . DS . 'fixtures'
                );
            } elseif (strpos($fixture, 'plugin.') === 0) {
                $parts = explode('.', $fixture, 3);
                $pluginName = $parts[1];
                $fixture = $parts[2];
                $fixturePaths = array(
                    App::pluginPath($pluginName) . 'tests' . DS . 'fixtures',
                    TESTS . 'fixtures',
                    VENDORS . 'tests' . DS . 'fixtures'
                );
            } else {
                $fixturePaths = array(
                    TESTS . 'fixtures',
                    VENDORS . 'tests' . DS . 'fixtures',
                    TEST_CAKE_CORE_INCLUDE_PATH . DS . 'cake' . DS . 'tests' . DS . 'fixtures'
                );
            }

            foreach ($fixturePaths as $path) {
                if (is_readable($path . DS . $fixture . '_fixture.php')) {
                    $fixtureFile = $path . DS . $fixture . '_fixture.php';
                    break;
                }
            }

            if (isset($fixtureFile)) {
                require_once($fixtureFile);
                $fixtureClass = Inflector::camelize($fixture) . 'Fixture';
                $this-&gt;_fixtures[$this-&gt;fixtures[$index]] =&amp;#038; new $fixtureClass($this-&gt;db);
                $this-&gt;_fixtureClassMap[Inflector::camelize($fixture)] = $this-&gt;fixtures[$index];
            }
        }

        if (empty($this-&gt;_fixtures)) {
            unset($this-&gt;_fixtures);
        }
    }
}
</code></pre>

<p>あとはテストケースでこのクラスを呼び出してやればOKです。</p>

<p>**/app/tests/cases/controllers/higes_controller.test.php**</p>

<pre><code>&lt;?php
App::import('Model', 'Uso');
App::import('Lib', 'MyCakeTestCase');

class HigesControllerTestCase extends MyCakeTestCase {
    var $fixtures = array(
        'app.hige.uso'      // /app/test/fixtures/hige/uso_fixture.php がロードされる
    );
?&gt;
</code></pre>

<h2 id="副作用:06041edaaf4ad9c158653456ce78f617">副作用</h2>

<p>テストケースで「App::import(&#8216;Lib&#8217;, &#8216;MyCakeTestCase&#8217;);」すると、なぜかMyCakeTestCaseもテスト対象になるらしく、テスト結果の「n/n test cases complete」の値が1増えます。</p>

<p>テスト結果のGreen/Redには影響しないので、無視してください。</p>

<h2 id="参考:06041edaaf4ad9c158653456ce78f617">参考</h2>

<ul>
<li><a href="http://d.hatena.ne.jp/hiromi2424/20101215/1292379625" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://d.hatena.ne.jp/hiromi2424/20101215/1292379625', 'App::import() は凄い &#8211; 24時間CakePHP']);" title="App::import() は凄い - 24時間CakePHP">App::import() は凄い &#8211; 24時間CakePHP</a>

<ul>
<li>本当はApp::importだけでできれば一番いいんですけどね。</li>
</ul></li>
</ul>

        </div>
      </div>
    </div>
    <div class="footer">
  <p>Powered by <a href="http://gohugo.io">Hugo</a>. This theme—Slim—is open sourced on <a href="https://github.com/zhe/hugo-theme-slim">Github</a>.</p>
</div>

  </div>
  <script src="http://1000k.github.io//js/slim.js"></script>
  <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-46659459-2', 'auto');
ga('send', 'pageview');

</script>


</body>

</html>